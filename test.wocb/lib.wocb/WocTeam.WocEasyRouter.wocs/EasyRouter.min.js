var EasyRouter;(function(EasyRouter){"use strict";var Router=function(){function Router(onAsyncErrCb,onRejectCb,onUnknownRouteCb){if(onRejectCb===void 0){onRejectCb=null}if(onUnknownRouteCb===void 0){onUnknownRouteCb=null}this.onRejectCb=onRejectCb;this.onUnknownRouteCb=onUnknownRouteCb;this.children=[];this.routes=[];this.listeners={};this.onNavRmListeners={};this.curQuery=null;this.curActivator=null;this.curChild=null;this.working=false;this.onAsyncErrCb=function(err){try{onAsyncErrCb(err)}catch(e){}}}Router.prototype.startRoot=function(config){var _this=this;if(this.isRoot!==undefined)throw Error("Cannot call startRoot(), the router is "+(this.isRoot?"already root":"a child"));this.isRoot=true;this.rootQSStack=[];this.rootBaseUrl=config.baseUrl;if(config.hashMode!==false)this.rootBaseUrl+="#";this.withHistory=!config.noHistory;var firstQueryString=window.history.state||config.firstQueryString||Router.getDefaultFirstQueryString(config);if(this.withHistory){window.onpopstate=this.makeOnPopState();window.onhashchange=this.makeOnHashChange()}for(var i=0,len=this.children.length;i<len;++i)this.children[i].startAsChild(this,this.withHistory);return this.doNavigate(firstQueryString,false).then(function(done){if(done){if(_this.withHistory&&_this.curQuery){window.history.replaceState(_this.curQuery.redirectedFrom||_this.curQuery.queryString,_this.curQuery.title,_this.toUrl(_this.curQuery.queryString,null))}}else throw _this.makeRejectError('Fail to navigate to the first URL: "'+firstQueryString+'"')})};Router.prototype.map=function(activators){var ra,compiledRoute;for(var i=0,len=activators.length;i<len;++i){ra=activators[i];if(typeof ra.route==="string")compiledRoute=Router.compileRoute(ra.route);else{if(!ra.canActivate)throw Error("Missing route: "+JSON.stringify(ra));compiledRoute=null}if(Object.freeze)Object.freeze(ra);this.routes.push({activator:ra,compiledRoute:compiledRoute});if(ra.child)this.children.push(ra.child)}return this};Router.prototype.mapUnknownRoutes=function(activator){if(Object.freeze)Object.freeze(activator);this.unknownActivator=activator;return this};Router.prototype.parentNavigateToUnknown=function(changeHist){return this.doNavigate(null,changeHist,null,null,true)};Router.prototype.startAsChild=function(parent,withHistory){if(this.isRoot)throw Error("Cannot call startAsChild() on the root router");if(this.parent){if(this.parent!==parent)throw Error("Router cannot have several parents");return}this.parent=parent;this.isRoot=false;this.withHistory=withHistory;for(var i=0,len=this.children.length;i<len;++i)this.children[i].startAsChild(this,this.withHistory)};Router.prototype.childNavigate=function(queryString,changeHist,parentUrl,parentQuery){return this.doNavigate(queryString,changeHist,parentUrl,parentQuery)};Router.prototype.leaveChildRouter=function(){var _this=this;if(!this.curQuery)return Promise.resolve(true);return this.canLeaveCurrent().then(function(can){if(!can)return false;return _this.setNewQuery(null,null).then(function(){return true})})};Router.prototype.navigate=function(queryString){return this.doNavigate(queryString,true)};Router.prototype.navigateToUnknown=function(){return this.doNavigate(null,true)};Router.prototype.navigateBack=function(level){if(level===void 0){level=1}if(!this.isRoot)throw Error("Method navigateBack() is available for root router only");if(level===0)return Promise.resolve(true);if(level<0)return Promise.resolve(false);var qs=this.rootQSStack[this.rootQSStack.length-level-1];if(qs===undefined)return Promise.resolve(false);return this.doNavigate(qs,true)};Router.prototype.addCanLeaveListener=function(cb,onNavRm){if(onNavRm===void 0){onNavRm=false}return this.addListener("canLeave",cb,onNavRm)};Router.prototype.removeCanLeaveListener=function(handle){return this.removeListener("canLeave",handle)};Router.prototype.addLeaveListener=function(cb,onNavRm){if(onNavRm===void 0){onNavRm=false}return this.addListener("leave",cb,onNavRm)};Router.prototype.removeLeaveListener=function(handle){return this.removeListener("leave",handle)};Router.prototype.addCanNavigateListener=function(cb,onNavRm){if(onNavRm===void 0){onNavRm=false}return this.addListener("canNavigate",cb,onNavRm)};Router.prototype.removeCanNavigateListener=function(handle){return this.removeListener("canNavigate",handle)};Router.prototype.addNavigateListener=function(cb,onNavRm){if(onNavRm===void 0){onNavRm=false}return this.addListener("navigate",cb,onNavRm)};Router.prototype.removeNavigateListener=function(handle){return this.removeListener("navigate",handle)};Router.prototype.doNavigate=function(queryString,changeHist,parentUrl,parentQuery,alreadyWorking){var _this=this;if(parentUrl===void 0){parentUrl=null}if(parentQuery===void 0){parentQuery=null}if(alreadyWorking===void 0){alreadyWorking=false}if(!alreadyWorking){if(this.working)return Promise.resolve(false);this.working=true}if(this.isRoot)this.rootQSStack.push(queryString);var query=this.makeQuery(queryString,parentQuery);if(this.curQuery&&this.curQuery.queryString===query.queryString){this.working=false;return Promise.resolve(true)}var p=this.canLeaveCurrent();p=p.then(function(can){if(!can)return false;return _this.searchRoute(query).then(function(matching){if(matching===null)return _this.parent?_this.parent.parentNavigateToUnknown(changeHist):false;return _this.fireListeners("canNavigate",matching.completedQuery,true).then(function(can){if(!can)return false;if(matching.activator.redirectTo)return _this.doNavigate(matching.activator.redirectTo,changeHist,parentUrl,parentQuery);return _this.doNavigateToMatching(matching,changeHist,parentUrl)})})});if(!alreadyWorking){p=p.then(function(done){_this.working=false;return done},function(err){_this.working=false;throw err})}return p};Router.prototype.canLeaveCurrent=function(){var promises=[];if(this.curActivator&&this.curActivator.canDeactivate){var can;try{can=this.curActivator.canDeactivate()}catch(err){this.callOnRejectCb(err,this.curQuery);can=false}if(!can)return Promise.resolve(false);if(can!==true)promises.push(can)}promises.push(this.fireListeners("canLeave",undefined,true));return Promise.all(promises).then(function(arr){for(var i=0,len=arr.length;i<len;++i){if(!arr[i])return false}return true})};Router.prototype.doNavigateToMatching=function(matching,changeHist,parentUrl){var _this=this;var activator=matching.activator,completed=matching.completedQuery,p;if(activator.child){if(activator===this.unknownActivator)this.callUnknownRouteCb(completed);if(this.curChild&&this.curChild!==activator.child)p=this.curChild.leaveChildRouter();else p=Promise.resolve(true);return p.then(function(done){if(!done)return false;var parentUrl=_this.toUrl(completed.processedQueryString,parentUrl),childQS=completed.remainingQueryString;return activator.child.childNavigate(childQS,changeHist,parentUrl,completed).then(function(done){_this.curChild=activator.child;if(done)return _this.setNewQuery(completed,activator).then(function(){return done});return done})})}if(this.curChild){p=this.curChild.leaveChildRouter();this.curChild=null}else p=Promise.resolve(true);return p.then(function(done){if(!done)return false;var title;if(!activator.title)title=null;else if(typeof activator.title==="string")title=activator.title;else title=_this.wrapUserCbOnErrorReject(activator.title,completed,completed);var finalRoute=Router.makeFinalQuery(completed,title);if(activator===_this.unknownActivator)_this.callUnknownRouteCb(finalRoute);return _this.setNewQuery(finalRoute,activator).then(function(){if(changeHist)_this.pushState(_this.curQuery,parentUrl);document.title=_this.curQuery.title;var activated=_this.wrapUserCbOnErrorReject(activator.activate,_this.curQuery,_this.curQuery);return activated?activated.then(function(){return true}):true})})};Router.prototype.pushState=function(query,parentUrl){if(!this.withHistory)return;var rootQuery=query;while(rootQuery.parent)rootQuery=rootQuery.parent;window.history.pushState(rootQuery.redirectedFrom||rootQuery.queryString,query.title,this.toUrl(query.queryString,parentUrl))};Router.prototype.toUrl=function(queryString,parentUrl){var url=queryString||"";url=parentUrl?parentUrl+url:url;return this.rootBaseUrl?this.rootBaseUrl+url:url};Router.prototype.setNewQuery=function(query,activator){var _this=this;var p=null;if(this.curActivator&&this.curActivator.deactivate){var deactivated=this.wrapUserCbOnErrorReject(this.curActivator.deactivate,query);if(deactivated)p=deactivated}this.curActivator=activator;this.curQuery=query;this.fireListeners("leave",undefined,false)["catch"](function(err){_this.onAsyncErrCb(err)});if(query){this.fireListeners("navigate",query,false)["catch"](function(err){_this.onAsyncErrCb(err)})}for(var k in this.onNavRmListeners){if(this.onNavRmListeners.hasOwnProperty(k))this.removeListener(this.onNavRmListeners[k]["type"],this.onNavRmListeners[k]["handle"])}return p?p:Promise.resolve()};Router.prototype.searchRoute=function(query){var pendingList=[],r,matchArr,can,matching;if(query.queryString!==null){for(var k in this.routes){if(!this.routes.hasOwnProperty(k))continue;r=this.routes[k];matchArr=this.matchActivator(query,r.activator,r.compiledRoute);can=matchArr[0];if(can===false)continue;matching=matchArr[1];if(can===true){if(pendingList.length===0)return Promise.resolve(matching);pendingList.push([Promise.resolve(true),matching]);break}else pendingList.push([can,matching])}}if(this.unknownActivator){matchArr=this.matchActivator(query,this.unknownActivator);can=matchArr[0];if(can!==false){matching=matchArr[1];pendingList.push([can===true?Promise.resolve(true):can,matching])}}var makeThenCb=function(matching,deeper){return function(activated){return activated?matching:deeper}};var pending,deeper=Promise.resolve(null);for(var i=pendingList.length-1;i>=0;--i){pending=pendingList[i];deeper=pending[0].then(makeThenCb(pending[1],deeper))}return deeper};Router.prototype.matchActivator=function(query,activator,cr){if(cr===void 0){cr=null}var completed;if(cr){completed=Router.makeCompletedQuery(query,cr,activator);if(!completed)return[false]}else completed=query;var matching={completedQuery:completed,activator:activator,compiledRoute:cr};if(!activator.canActivate)return[true,matching];var can=this.wrapUserCbOnErrorReject(activator.canActivate,completed,completed);return[can,matching]};Router.prototype.makeQuery=function(queryString,parentQuery){var hash,params;if(queryString===null||queryString===undefined){queryString=null;hash=null;params=null}else{if(this.curQuery&&this.curQuery.queryString===queryString)return this.curQuery;var hashPos=queryString.indexOf("#");hash=hashPos===-1?null:queryString.slice(hashPos+1);if(hash==="")hash=null;var paramsPos=queryString.indexOf("?");if(paramsPos===-1)params=null;else{var paramsStr=hashPos===-1?queryString.slice(paramsPos+1):queryString.slice(paramsPos+1,hashPos),pTokens=paramsStr.split("&"),nameVal;params={};for(var i=0,len=pTokens.length;i<len;++i){nameVal=pTokens[i].split("=");params[nameVal[0]]=nameVal[1]||""}}}var query={queryString:queryString,queryHash:hash,queryParams:params};if(parentQuery)query.parent=parentQuery;if(Object.freeze)Object.freeze(query);return query};Router.makeCompletedQuery=function(query,compiledRoute,activator){var m=compiledRoute.regexp.exec(query.queryString);if(m===null)return null;var params={},pNamesLen=compiledRoute.pNames.length,pName,pVal,index=0;while(index<pNamesLen){pName=compiledRoute.pNames[index];pVal=m[++index];params[pName]=pVal===undefined?undefined:decodeURIComponent(pVal)}var lastIndex=m.length-1;var remaining=lastIndex>pNamesLen?m[lastIndex]:null,processed=remaining?query.queryString.slice(0,-remaining.length):query.queryString;var completed={queryString:query.queryString,queryHash:query.queryHash,queryParams:query.queryParams,route:activator.route,routeParams:params,processedQueryString:processed,remainingQueryString:remaining,title:null};if(query.parent)completed.parent=query.parent;if(activator.useQueryString){completed.redirectedFrom=completed.queryString;completed.queryString=activator.useQueryString}if(Object.freeze)Object.freeze(completed);return completed};Router.makeFinalQuery=function(completedQuery,title){if(!title)return completedQuery;var finalQuery={queryString:completedQuery.queryString,queryHash:completedQuery.queryHash,queryParams:completedQuery.queryParams,route:completedQuery.route,routeParams:completedQuery.routeParams,processedQueryString:completedQuery.processedQueryString,remainingQueryString:completedQuery.remainingQueryString,title:title};if(completedQuery.parent)finalQuery.parent=completedQuery.parent;if(Object.freeze)Object.freeze(finalQuery);return finalQuery};Router.prototype.addListener=function(type,cb,onNavRm){if(onNavRm===void 0){onNavRm=false}var listeners=this.listeners[type];if(listeners===undefined)listeners=this.listeners[type]=[];var handle=listeners.length;listeners[handle]=cb;if(onNavRm){this.onNavRmListeners[type+"~"+handle]={type:type,handle:handle}}return handle};Router.prototype.removeListener=function(type,handle){var listeners=this.listeners[type];if(listeners===undefined||listeners[handle]===undefined)throw Error('Unknown listener "'+type+'": "'+handle+'"');delete listeners[handle];var k=type+"~"+handle;if(this.onNavRmListeners[k])delete this.onNavRmListeners[k]};Router.prototype.fireListeners=function(type,arg,returnBoolean){var listeners=this.listeners[type];if(listeners===undefined)return returnBoolean?Promise.resolve(true):Promise.resolve();var promArr=[];for(var k in listeners){if(listeners.hasOwnProperty(k))promArr.push(arg===undefined?listeners[k]():listeners[k](arg))}var p=Promise.all(promArr);if(returnBoolean){p=p.then(function(resArr){for(var i=0,len=resArr.length;i<len;++i){if(!resArr[i])return false}return true})}return p};Router.prototype.makeOnPopState=function(){var _this=this;return function(e){if(e.state===null||e.state===undefined)return;try{_this.doNavigate(e.state,false)}catch(err){_this.onAsyncErrCb(err)}}};Router.prototype.makeOnHashChange=function(){var _this=this;return function(){try{var queryString=window.location.hash;if(queryString.length>=1&&queryString[0]==="#")queryString=queryString.slice(1);_this.doNavigate(queryString,false)}catch(err){_this.onAsyncErrCb(err)}}};Router.getDefaultFirstQueryString=function(config){if(config.hashMode!==false){var hash=window.location.hash;if(!hash)return"";if(hash.length>=1&&hash[0]==="#")hash=hash.slice(1);return hash}var path=window.location.pathname;var baseLen=config.baseUrl.length;if(path.length<=baseLen)return"";if(path.slice(0,baseLen)!==config.baseUrl)return"";return path.slice(baseLen)};Router.prototype.callUnknownRouteCb=function(query){if(this.onUnknownRouteCb){try{this.onUnknownRouteCb(query)}catch(err){this.onAsyncErrCb(err)}}};Router.prototype.wrapUserCbOnErrorReject=function(cb,query,arg){var _this=this;if(query===void 0){query=undefined}if(arg===void 0){arg=undefined}var res;try{if(arg===undefined)res=cb();else res=cb(arg)}catch(err){throw this.callOnRejectCb(err,query)}if(typeof res==="object"&&res["then"]&&res["catch"]){res=res["catch"](function(err){throw _this.callOnRejectCb(err)})}return res};Router.prototype.makeRejectError=function(msg,query){if(query===void 0){query=undefined}return this.callOnRejectCb(Error(msg),query)};Router.prototype.callOnRejectCb=function(err,query){if(query===void 0){query=undefined}if(this.onRejectCb){try{this.onRejectCb(err,query)}catch(e){this.onAsyncErrCb(e)}}return err};Router.compileRoute=function(route){var pNames=[];var withStar=route.length>0&&route[route.length-1]==="*";if(withStar)route=route.slice(0,-1);route=route.replace(/\(/g,"==par_open==").replace(/\)/g,"==par_close==").replace(/([\/\?&=])?:(\w+)/g,function(_,sep,key){pNames.push(key);if(!sep)sep="";return sep+"([^/\\?&=]+)"}).replace(/==par_open==/g,"(?:").replace(/==par_close==/g,")?").replace(/\*/g,"\\*");if(withStar)route+="(.*)";return{regexp:new RegExp("^"+route+"$"),pNames:pNames,withStar:withStar}};Router.appendUrl=function(a,b){var trailingSlash=a.slice(-1)==="/";if(trailingSlash)return b.charAt(0)==="/"?a+b.slice(1):a+b;return a+"/"+b};return Router}();EasyRouter.Router=Router})(EasyRouter||(EasyRouter={}));